//===========================================================================
// 
// Just another Warcraft III map
// 
//   Warcraft III map script
//   Generated by the Warcraft III World Editor
//   Date: Sun Dec 29 13:57:08 2019
//   Map Author: Unknown
// 
//===========================================================================

//***************************************************************************
//*
//*  Global Variables
//*
//***************************************************************************

globals
    // Generated
    trigger                 gg_trg_Melee_Initialization = null

    // Random Groups
    integer array gg_rg_000
endglobals

function InitGlobals takes nothing returns nothing
endfunction

//***************************************************************************
//*
//*  Custom Script Code
//*
//***************************************************************************

//***************************************************************************
//*
//*  Random Groups
//*
//***************************************************************************

function InitRandomGroups takes nothing returns nothing
    local integer curset

    // Group 0 - Untitled Group
    call RandomDistReset(  )
    call RandomDistAddItem( 0, 10 )
    call RandomDistAddItem( 1, 90 )
    set curset = RandomDistChoose(  )

    if (curset == 0) then
        set gg_rg_000[0] = 'nrdk'
        set gg_rg_000[1] = 'nrwm'
    elseif (curset == 1) then
        set gg_rg_000[0] = ChooseRandomCreep( -1 )
        set gg_rg_000[1] = -1
    else
        set gg_rg_000[0] = -1
        set gg_rg_000[1] = -1
    endif

endfunction

//***************************************************************************
//*
//*  Map Item Tables
//*
//***************************************************************************

function ItemTable000000_DropItems takes nothing returns nothing
    local widget  trigWidget = null
    local unit    trigUnit   = null
    local integer itemID     = 0
    local boolean canDrop    = true

    set trigWidget = bj_lastDyingWidget
    if (trigWidget == null) then
        set trigUnit = GetTriggerUnit()
    endif

    if (trigUnit != null) then
        set canDrop = not IsUnitHidden(trigUnit)
        if (canDrop and GetChangingUnit() != null) then
            set canDrop = (GetChangingUnitPrevOwner() == Player(PLAYER_NEUTRAL_AGGRESSIVE))
        endif
    endif

    if (canDrop) then
        // Item set 0
        call RandomDistReset(  )
        call RandomDistAddItem( 'ratf', 100 )
        set itemID = RandomDistChoose(  )
        if (trigUnit != null) then
            call UnitDropItem( trigUnit, itemID )
        else
            call WidgetDropItem( trigWidget, itemID )
        endif

    endif

    set bj_lastDyingWidget = null
    call DestroyTrigger(GetTriggeringTrigger())
endfunction


//***************************************************************************
//*
//*  Unit Item Tables
//*
//***************************************************************************

function Unit000004_DropItems takes nothing returns nothing
    local widget  trigWidget = null
    local unit    trigUnit   = null
    local integer itemID     = 0
    local boolean canDrop    = true

    set trigWidget = bj_lastDyingWidget
    if (trigWidget == null) then
        set trigUnit = GetTriggerUnit()
    endif

    if (trigUnit != null) then
        set canDrop = not IsUnitHidden(trigUnit)
        if (canDrop and GetChangingUnit() != null) then
            set canDrop = (GetChangingUnitPrevOwner() == Player(PLAYER_NEUTRAL_AGGRESSIVE))
        endif
    endif

    if (canDrop) then
        // Item set 0
        call RandomDistReset(  )
        call RandomDistAddItem( 'ofro', 50 )
        call RandomDistAddItem( 'ofr2', 50 )
        set itemID = RandomDistChoose(  )
        if (trigUnit != null) then
            call UnitDropItem( trigUnit, itemID )
        else
            call WidgetDropItem( trigWidget, itemID )
        endif

        // Item set 1
        call RandomDistReset(  )
        call RandomDistAddItem( 'ratf', 10 )
        call RandomDistAddItem( -1, 90 )
        set itemID = RandomDistChoose(  )
        if (trigUnit != null) then
            call UnitDropItem( trigUnit, itemID )
        else
            call WidgetDropItem( trigWidget, itemID )
        endif

    endif

    set bj_lastDyingWidget = null
    call DestroyTrigger(GetTriggeringTrigger())
endfunction


//***************************************************************************
//*
//*  Items
//*
//***************************************************************************

function CreateAllItems takes nothing returns nothing
    local integer itemID

    set itemID = ChooseRandomItemEx( ITEM_TYPE_PURCHASABLE, 4 )
    if (itemID != -1) then
        call CreateItem( itemID, 751.3, -1019.0 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_PERMANENT, 0 )
    if (itemID != -1) then
        call CreateItem( itemID, 261.6, -1023.3 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_CHARGED, 1 )
    if (itemID != -1) then
        call CreateItem( itemID, 386.6, -1025.5 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_POWERUP, 2 )
    if (itemID != -1) then
        call CreateItem( itemID, 508.2, -1027.6 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_ARTIFACT, 3 )
    if (itemID != -1) then
        call CreateItem( itemID, 610.0, -1027.6 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_ANY, -1 )
    if (itemID != -1) then
        call CreateItem( itemID, 1269.4, -1012.6 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_CAMPAIGN, 5 )
    if (itemID != -1) then
        call CreateItem( itemID, 886.1, -1019.0 )
    endif
    set itemID = ChooseRandomItemEx( ITEM_TYPE_MISCELLANEOUS, 6 )
    if (itemID != -1) then
        call CreateItem( itemID, 1028.5, -1027.6 )
    endif
    call RandomDistReset(  )
    call RandomDistAddItem( ChooseRandomItemEx( ITEM_TYPE_ANY, -1 ), 10 )
    call RandomDistAddItem( ChooseRandomItemEx( ITEM_TYPE_ARTIFACT, 2 ), 20 )
    call RandomDistAddItem( 'ratf', 30 )
    call RandomDistAddItem( -1, 40 )
    set itemID = RandomDistChoose(  )
    if (itemID != -1) then
        call CreateItem( itemID, 1154.2, -1019.0 )
    endif
    call CreateItem( 'ratf', 138.3, -1027.6 )
endfunction

//***************************************************************************
//*
//*  Unit Creation
//*
//***************************************************************************

//===========================================================================
function CreateUnitsForPlayer0 takes nothing returns nothing
    local player p = Player(0)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set u = CreateUnit( p, 'hpea', -3.3, -1.4, 154.418 )
    set u = CreateUnit( p, 'hfoo', 127.2, -7.1, 290.220 )
    set life = GetUnitState( u, UNIT_STATE_LIFE )
    call SetUnitState( u, UNIT_STATE_LIFE, 0.50 * life )
    call SetUnitAcquireRange( u, 200.0 )
    set u = CreateUnit( p, 'hkni', 256.3, -2.6, 208.980 )
    call UnitAddItemToSlotById( u, 'ratf', 1 )
    call UnitAddItemToSlotById( u, 'ckng', 4 )
    set u = CreateUnit( p, 'hrif', 380.2, -1.1, 122.620 )
    set t = CreateTrigger(  )
    call TriggerRegisterUnitEvent( t, u, EVENT_UNIT_DEATH )
    call TriggerRegisterUnitEvent( t, u, EVENT_UNIT_CHANGE_OWNER )
    call TriggerAddAction( t, function ItemTable000000_DropItems )
    set u = CreateUnit( p, 'hmtm', 519.3, -16.6, 317.080 )
    set t = CreateTrigger(  )
    call TriggerRegisterUnitEvent( t, u, EVENT_UNIT_DEATH )
    call TriggerRegisterUnitEvent( t, u, EVENT_UNIT_CHANGE_OWNER )
    call TriggerAddAction( t, function Unit000004_DropItems )
    set u = CreateUnit( p, 'Hpal', 4.5, -117.9, 28.170 )
    call SetUnitState( u, UNIT_STATE_MANA, 150 )
    call SelectHeroSkill( u, 'AHds' )
    call IssueImmediateOrder( u, "divineshield" )
    set u = CreateUnit( p, 'Hamg', 130.0, -139.4, 144.540 )
    call SetHeroLevel( u, 10, false )
    call SetHeroStr( u, 30, true )
    call SetHeroAgi( u, 26, true )
    call SetHeroInt( u, 999, true )
    set u = CreateUnit( p, 'Hmkg', 259.3, -126.6, 253.780 )
    call SetHeroLevel( u, 6, false )
    call SelectHeroSkill( u, 'AHav' )
    call SelectHeroSkill( u, 'AHtc' )
    call SelectHeroSkill( u, 'AHtc' )
    call SelectHeroSkill( u, 'AHbh' )
    call SelectHeroSkill( u, 'AHbh' )
    call SelectHeroSkill( u, 'AHbh' )
endfunction

//===========================================================================
function CreateNeutralHostile takes nothing returns nothing
    local player p = Player(PLAYER_NEUTRAL_AGGRESSIVE)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set unitID = ChooseRandomCreep( -1 )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 136.4, -771.6, 45.080 )
    endif
    set unitID = ChooseRandomCreep( 5 )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 342.8, -755.3, 359.090 )
    endif
    set unitID = gg_rg_000[1]
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 611.5, -779.6, 225.800 )
    endif
    call RandomDistReset(  )
    call RandomDistAddItem( 'ndtr', 10 )
    call RandomDistAddItem( 'ndtb', 60 )
    call RandomDistAddItem( ChooseRandomCreep( 10 ), 5 )
    call RandomDistAddItem( -1, 25 )
    set unitID = RandomDistChoose(  )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 856.2, -787.7, 301.560 )
    endif
endfunction

//===========================================================================
function CreateNeutralPassiveBuildings takes nothing returns nothing
    local player p = Player(PLAYER_NEUTRAL_PASSIVE)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set u = CreateUnit( p, 'ngol', 128.0, -384.0, 270.000 )
    call SetResourceAmount( u, 500 )
    set unitID = ChooseRandomNPBuilding(  )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 640.0, -384.0, 270.000 )
    endif
    set unitID = ChooseRandomNPBuilding(  )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 1024.0, -384.0, 270.000 )
    endif
    set unitID = ChooseRandomNPBuilding(  )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 1408.0, -384.0, 270.000 )
    endif
    call RandomDistReset(  )
    call RandomDistAddItem( 'ngme', 10 )
    call RandomDistAddItem( 'nshp', 50 )
    call RandomDistAddItem( -1, 40 )
    set unitID = RandomDistChoose(  )
    if (unitID != -1) then
        set u = CreateUnit( p, unitID, 1792.0, -384.0, 270.000 )
    endif
endfunction

//===========================================================================
function CreatePlayerBuildings takes nothing returns nothing
endfunction

//===========================================================================
function CreatePlayerUnits takes nothing returns nothing
    call CreateUnitsForPlayer0(  )
endfunction

//===========================================================================
function CreateAllUnits takes nothing returns nothing
    call CreateNeutralPassiveBuildings(  )
    call CreatePlayerBuildings(  )
    call CreateNeutralHostile(  )
    call CreatePlayerUnits(  )
endfunction

//***************************************************************************
//*
//*  Triggers
//*
//***************************************************************************

//===========================================================================
// Trigger: Melee Initialization
//
// Default melee game initialization for all players
//===========================================================================
function Trig_Melee_Initialization_Actions takes nothing returns nothing
    call MeleeStartingVisibility(  )
    call MeleeStartingHeroLimit(  )
    call MeleeGrantHeroItems(  )
    call MeleeStartingResources(  )
    call MeleeClearExcessUnits(  )
    call MeleeStartingUnits(  )
    call MeleeStartingAI(  )
    call MeleeInitVictoryDefeat(  )
endfunction

//===========================================================================
function InitTrig_Melee_Initialization takes nothing returns nothing
    set gg_trg_Melee_Initialization = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Melee_Initialization, function Trig_Melee_Initialization_Actions )
endfunction

//===========================================================================
function InitCustomTriggers takes nothing returns nothing
    call InitTrig_Melee_Initialization(  )
endfunction

//===========================================================================
function RunInitializationTriggers takes nothing returns nothing
    call ConditionalTriggerExecute( gg_trg_Melee_Initialization )
endfunction

//***************************************************************************
//*
//*  Players
//*
//***************************************************************************

function InitCustomPlayerSlots takes nothing returns nothing

    // Player 0
    call SetPlayerStartLocation( Player(0), 0 )
    call SetPlayerColor( Player(0), ConvertPlayerColor(0) )
    call SetPlayerRacePreference( Player(0), RACE_PREF_HUMAN )
    call SetPlayerRaceSelectable( Player(0), true )
    call SetPlayerController( Player(0), MAP_CONTROL_USER )

endfunction

function InitCustomTeams takes nothing returns nothing
    // Force: TRIGSTR_002
    call SetPlayerTeam( Player(0), 0 )

endfunction

//***************************************************************************
//*
//*  Main Initialization
//*
//***************************************************************************

//===========================================================================
function main takes nothing returns nothing
    call SetCameraBounds( -3328.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), -3584.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM), 3328.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), 3072.0 - GetCameraMargin(CAMERA_MARGIN_TOP), -3328.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), 3072.0 - GetCameraMargin(CAMERA_MARGIN_TOP), 3328.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), -3584.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM) )
    call SetDayNightModels( "Environment\\DNC\\DNCLordaeron\\DNCLordaeronTerrain\\DNCLordaeronTerrain.mdl", "Environment\\DNC\\DNCLordaeron\\DNCLordaeronUnit\\DNCLordaeronUnit.mdl" )
    call NewSoundEnvironment( "Default" )
    call SetAmbientDaySound( "LordaeronSummerDay" )
    call SetAmbientNightSound( "LordaeronSummerNight" )
    call SetMapMusic( "Music", true, 0 )
    call InitRandomGroups(  )
    call CreateAllItems(  )
    call CreateAllUnits(  )
    call InitBlizzard(  )
    call InitGlobals(  )
    call InitCustomTriggers(  )
    call RunInitializationTriggers(  )

endfunction

//***************************************************************************
//*
//*  Map Configuration
//*
//***************************************************************************

function config takes nothing returns nothing
    call SetMapName( "Just another Warcraft III map" )
    call SetMapDescription( "Nondescript" )
    call SetPlayers( 1 )
    call SetTeams( 1 )
    call SetGamePlacement( MAP_PLACEMENT_USE_MAP_SETTINGS )

    call DefineStartLocation( 0, 49.1, 377.9 )

    // Player setup
    call InitCustomPlayerSlots(  )
    call SetPlayerSlotAvailable( Player(0), MAP_CONTROL_USER )
    call InitGenericPlayerSlots(  )
endfunction

